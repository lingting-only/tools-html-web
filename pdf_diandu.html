<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PDF课程点读工具</title>
  <!-- 1. 先引入PDF.js核心库（使用本地路径） -->
  <script src="./lib/pdf.min.js"></script>

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: "微软雅黑", "PingFang SC", "Helvetica Neue", Arial, sans-serif;
      max-width: 1000px;
      margin: 20px auto;
      padding: 0 20px;
      background-color: #f9f7f0;
      color: #333;
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="%23f9f7f0"/><path d="M0,50 Q25,25 50,50 T100,50" fill="none" stroke="%23e8e0d0" stroke-width="0.5"/></svg>');
    }

    h2 {
      text-align: center;
      color: #4a6fa5;
      margin-bottom: 30px;
      font-size: 28px;
      font-weight: 600;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
      padding: 15px 0;
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      align-items: center;
      margin-bottom: 20px;
      padding: 20px;
      background-color: white;
      border-radius: 12px;
      box-shadow: 0 3px 15px rgba(0, 0, 0, 0.1);
      max-width: 100%;
      border: 2px solid #e3f2fd;
    }

    #pdfFileInput {
      flex: 1;
      min-width: 200px;
      padding: 10px 12px;
      border: 2px solid #d1ecf1;
      border-radius: 8px;
      font-size: 14px;
      background-color: #f8fafc;
      transition: all 0.3s ease;
    }

    #pdfFileInput:focus {
      outline: none;
      border-color: #4a6fa5;
      box-shadow: 0 0 0 3px rgba(74, 111, 165, 0.1);
    }

    #pdfContainer {
      position: relative;
      border: 2px solid #e3f2fd;
      border-radius: 12px;
      overflow: hidden;
      margin-top: 20px;
      background-color: white;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.12);
      transition: box-shadow 0.3s ease;
      max-width: 100%;
    }

    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      margin: 20px 0 0;
      padding: 15px;
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      border: 1px solid #e3f2fd;
    }

    #pageInfo {
      font-size: 14px;
      color: #4a6fa5;
      font-weight: 600;
      min-width: 100px;
      text-align: center;
      padding: 8px 12px;
      background-color: #f0f8ff;
      border-radius: 6px;
    }

    button {
      padding: 12px 24px;
      background-color: #4a6fa5;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(74, 111, 165, 0.3);
    }

    button:hover {
      background-color: #3a5a85;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(74, 111, 165, 0.4);
    }

    button:active {
      transform: translateY(0);
      box-shadow: 0 2px 6px rgba(74, 111, 165, 0.3);
    }

    button:disabled {
      background-color: #b0c4de;
      cursor: not-allowed;
      box-shadow: none;
    }

    #status {
      color: #555;
      margin: 15px 0;
      padding: 14px 18px;
      background-color: #f8fafc;
      border-radius: 8px;
      border-left: 4px solid #4a6fa5;
      font-size: 14px;
      line-height: 1.5;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    #pdfContainer:hover {
      box-shadow: 0 6px 25px rgba(0, 0, 0, 0.15);
    }

    .text-highlight {
      position: absolute;
      background-color: rgba(255, 152, 0, 0.6);
      border-radius: 4px;
      pointer-events: none;
      z-index: 10;
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(255, 152, 0, 0.3);
    }

    /* 添加一些装饰元素 */
    .header-decoration {
      height: 6px;
      background: linear-gradient(90deg, #4a6fa5, #6b8ecc, #4a6fa5);
      border-radius: 3px;
      margin-bottom: 30px;
    }

    @media (max-width: 768px) {
      body {
        margin: 10px;
        padding: 0 15px;
      }

      h2 {
        font-size: 22px;
        margin-bottom: 20px;
        padding: 12px 0;
      }

      .controls {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
        padding: 18px;
      }

      .pagination {
        flex-direction: row;
        gap: 12px;
        padding: 14px;
      }

      #pageInfo {
        font-size: 13px;
        min-width: 80px;
        padding: 6px 10px;
      }

      #pdfFileInput {
        width: 100%;
        padding: 10px;
      }

      button {
        padding: 10px 20px;
        font-size: 13px;
      }

      #status {
        font-size: 13px;
        padding: 12px 16px;
      }

      #pdfContainer {
        margin-top: 15px;
        border-radius: 10px;
      }

      .header-decoration {
        margin-bottom: 20px;
      }
    }
  </style>
</head>

<body>
  <h2>PDF文件点读工具</h2>
  <div class="header-decoration"></div>
  <div class="controls">
    <input type="file" id="pdfFileInput" accept=".pdf" />
    <button onclick="stopReading()">停止朗读</button>
  </div>
  <!-- 新增状态提示，方便排查问题 -->
  <div id="status">请选择PDF文件（仅支持文本型PDF）</div>
  <div id="pdfContainer">
    <div class="pagination" style="display: none;">
      <button onclick="goToPreviousPage()">上一页</button>
      <span id="pageInfo">页码：0 / 0</span>
      <button onclick="goToNextPage()">下一页</button>
    </div>
  </div>

  <script>
    // ========== 关键修复1：使用本地文件引用PDF.js ==========
    // 正确配置PDF.js Worker
    if (typeof pdfjsLib !== 'undefined') {
      // 禁用Worker，使用内置的解析器
      pdfjsLib.GlobalWorkerOptions.workerSrc = null;
    } else {
      document.getElementById('status').innerText = 'PDF.js库加载失败，请检查网络';
    }

    // 全局变量
    let pdfDoc = null;
    let pageNum = 1;
    let pageRendering = false;
    let speechInstance = null;
    let highlightElement = null;
    const statusDom = document.getElementById('status');

    // ========== 关键修复2：增加文件加载错误处理 ==========
    document.getElementById('pdfFileInput').addEventListener('change', function (e) {
      const file = e.target.files[0];
      if (!file) {
        statusDom.innerText = '未选择文件';
        return;
      }

      // 校验文件类型
      if (file.type !== 'application/pdf') {
        statusDom.innerText = '请选择有效的PDF文件';
        return;
      }

      statusDom.innerText = `正在加载文件：${file.name}...`;
      const fileReader = new FileReader();

      // 增加读取错误处理
      fileReader.onerror = function () {
        statusDom.innerText = '文件读取失败，请检查文件是否损坏';
      };

      fileReader.onload = function () {
        try {
          const typedArray = new Uint8Array(this.result);
          // 加载PDF并增加错误捕获
          pdfjsLib.getDocument({
            data: typedArray,
            // 关键配置：禁用跨域限制（仅本地测试用）
            disableFontFace: true
          }).promise.then(function (pdf) {
            pdfDoc = pdf;
            pageNum = 1; // 重置页码为第一页
            statusDom.innerText = `文件加载成功，共${pdf.numPages}页`;
            renderPage(pageNum);
            updatePageInfo(); // 更新页码信息
            // 显示分页控件
            document.querySelector('.pagination').style.display = 'flex';
          }).catch(function (err) {
            statusDom.innerText = `PDF解析失败：${err.message}`;
            console.error('PDF解析错误：', err);
          });
        } catch (err) {
          statusDom.innerText = `文件处理失败：${err.message}`;
        }
      };
      fileReader.readAsArrayBuffer(file);
    });

    // 渲染PDF页面（增加错误处理）
    function renderPage(num) {
      if (!pdfDoc) return;
      pageRendering = true;
      statusDom.innerText = `正在渲染第${num}页...`;

      pdfDoc.getPage(num).then(function (page) {
        // 获取控制区域的宽度，确保PDF容器与控制区域宽度一致
        const controlsWidth = document.querySelector('.controls').offsetWidth;

        // 计算缩放比例，使PDF宽度适应控制区域宽度
        const originalViewport = page.getViewport({ scale: 1 });
        const scale = controlsWidth / originalViewport.width;

        const viewport = page.getViewport({ scale: scale });
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.height = viewport.height;
        canvas.width = viewport.width;

        const container = document.getElementById('pdfContainer');
        // 保存分页控件
        const paginationElement = container.querySelector('.pagination');

        container.innerHTML = '';
        container.style.height = `auto`;
        container.style.width = `${controlsWidth}px`;
        container.appendChild(canvas);

        // 重新添加分页控件到容器底部
        if (paginationElement) {
          container.appendChild(paginationElement);
        }

        const renderContext = {
          canvasContext: ctx,
          viewport: viewport
        };
        const renderTask = page.render(renderContext);

        renderTask.promise.then(function () {
          pageRendering = false;
          statusDom.innerText = `第${num}页渲染完成，点击文本即可朗读`;
          // 提取文本并绑定事件
          page.getTextContent().then(function (textContent) {
            bindTextClickEvent(container, textContent, viewport);
          }).catch(function (err) {
            statusDom.innerText = `提取文本失败：${err.message}（可能是图片型PDF）`;
          });
        }).catch(function (err) {
          statusDom.innerText = `页面渲染失败：${err.message}`;
          pageRendering = false;
        });
      }).catch(function (err) {
        statusDom.innerText = `获取页面失败：${err.message}`;
        pageRendering = false;
      });
    }

    // 绑定点击事件（逻辑不变，增加空值判断）
    function bindTextClickEvent(container, textContent, viewport) {
      if (!textContent || !textContent.items) return;

      container.addEventListener('click', function (e) {
        const rect = container.getBoundingClientRect();
        const clickX = e.clientX - rect.left;
        const clickY = e.clientY - rect.top;

        const matchedText = findTextAtPosition(textContent, clickX, clickY, viewport);
        if (!matchedText) {
          statusDom.innerText = '未识别到可朗读的文本（可能点击到空白处）';
          return;
        }

        createHighlight(container, matchedText, viewport);
        readTextAloud(matchedText.str);
        statusDom.innerText = `正在朗读：${matchedText.str.substring(0, 20)}...`;
      });
    }

    // 坐标匹配文本（优化识别准确度）
    function findTextAtPosition(textContent, x, y, viewport) {
      let matchedItem = null;
      let closestDistance = Infinity;

      textContent.items.forEach(function (item) {
        const transform = pdfjsLib.Util.transform(viewport.transform, item.transform);
        const textX = transform[4];
        const textY = transform[5];
        const textWidth = item.width * viewport.scale;
        const textHeight = item.height * viewport.scale;

        // 计算文本项的中心点
        const centerX = textX + textWidth / 2;
        const centerY = textY - textHeight / 2;

        // 计算点击坐标到文本项中心点的距离
        const distance = Math.sqrt(Math.pow(x - centerX, 2) + Math.pow(y - centerY, 2));

        // 检查点击坐标是否在文本项的边界框内，允许一定的误差
        const padding = 2; // 增加一些 padding，提高识别率
        if (x >= textX - padding && x <= textX + textWidth + padding &&
          y >= textY - textHeight - padding && y <= textY + padding) {
          // 如果找到多个匹配项，选择距离中心点最近的一个
          if (distance < closestDistance) {
            closestDistance = distance;
            matchedItem = item;
          }
        }
      });
      return matchedItem;
    }

    // 创建高亮（逻辑不变）
    function createHighlight(container, textItem, viewport) {
      if (highlightElement) {
        highlightElement.remove();
        highlightElement = null;
      }

      const transform = pdfjsLib.Util.transform(viewport.transform, textItem.transform);
      const x = transform[4];
      const y = transform[5] - textItem.height * viewport.scale;
      const width = textItem.width * viewport.scale;
      const height = textItem.height * viewport.scale;

      highlightElement = document.createElement('div');
      highlightElement.className = 'text-highlight';
      highlightElement.style.left = `${x}px`;
      highlightElement.style.top = `${y}px`;
      highlightElement.style.width = `${width}px`;
      highlightElement.style.height = `${height}px`;
      container.appendChild(highlightElement);
    }

    // 语音朗读（逻辑不变）
    function readTextAloud(text) {
      if (speechInstance) {
        window.speechSynthesis.cancel();
      }

      if (!('SpeechSynthesisUtterance' in window)) {
        alert('你的浏览器不支持语音朗读，请使用Chrome/Edge');
        return;
      }

      speechInstance = new SpeechSynthesisUtterance(text);
      speechInstance.lang = 'zh-CN';
      speechInstance.rate = 0.9;
      speechInstance.pitch = 1.2;
      speechInstance.volume = 1;

      speechInstance.onend = function () {
        if (highlightElement) {
          highlightElement.remove();
          highlightElement = null;
        }
        statusDom.innerText = '朗读完成，可继续点击其他文本';
      };

      window.speechSynthesis.speak(speechInstance);
    }

    // 停止朗读（逻辑不变）
    function stopReading() {
      if (speechInstance) {
        window.speechSynthesis.cancel();
        speechInstance = null;
      }
      if (highlightElement) {
        highlightElement.remove();
        highlightElement = null;
      }
      statusDom.innerText = '已停止朗读';
    }

    // 更新页码信息
    function updatePageInfo() {
      const pageInfoElement = document.getElementById('pageInfo');
      if (pdfDoc) {
        pageInfoElement.innerText = `页码：${pageNum} / ${pdfDoc.numPages}`;
      } else {
        pageInfoElement.innerText = '页码：0 / 0';
      }
    }

    // 跳转到上一页
    function goToPreviousPage() {
      if (pdfDoc && pageNum > 1) {
        pageNum--;
        renderPage(pageNum);
        updatePageInfo();
      }
    }

    // 跳转到下一页
    function goToNextPage() {
      if (pdfDoc && pageNum < pdfDoc.numPages) {
        pageNum++;
        renderPage(pageNum);
        updatePageInfo();
      }
    }

    // 将函数暴露到全局作用域，以便按钮可以调用
    window.stopReading = stopReading;
    window.updatePageInfo = updatePageInfo;
    window.goToPreviousPage = goToPreviousPage;
    window.goToNextPage = goToNextPage;
  </script>
</body>

</html>